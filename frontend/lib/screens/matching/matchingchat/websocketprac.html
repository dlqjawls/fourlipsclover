<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>웹소켓 채팅방</title>
    <style>
        .chat-container {
            width: 300px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
        .chat-header {
            text-align: center;
            margin-bottom: 10px;
        }
        .messages {
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            margin-bottom: 10px;
        }
        .input-area {
            display: flex;
            justify-content: space-between;
        }
        input[type="text"] {
            width: 80%;
            padding: 5px;
        }
        button {
            padding: 5px 10px;
        }
    </style>
    
    <!-- SockJS와 Stomp.js CDN 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <h2>실시간 채팅방</h2>
    </div>

    <div class="messages" id="messages">
        <!-- 채팅 메시지가 여기에 표시됩니다. -->
    </div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." />
        <button id="sendButton">전송</button>
    </div>
</div>

<script>
    const socket = new SockJS('http://localhost:8090/chat');
    const stompClient = Stomp.over(socket);

    const token = "Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIzOTYyMTE1NzgyIiwibWVtYmVySWQiOjM5NjIxMTU3ODIsImVtYWlsIjoic2Vqb25nOTgwOTI5bmluaUBnbWFpbC5jb20iLCJuaWNrbmFtZSI6IuuwleyLnO2YhCIsImlhdCI6MTc0MzYxMDY2MiwiZXhwIjoxNzQzNjE0MjYyfQ.BZqRPir63cCtyG6x4wCXuqdXEf7deT30Cw-Y8Xw0hNs";

    // 매칭 ID (임의로 지정한 값)
    const matchId = 2;  // 테스트용 매칭 ID

    // WebSocket 서버에 연결 후, 메시지 수신을 위해 구독
    stompClient.connect({ 
        Authorization: token 
    }, function(frame) {
        console.log('Connected: ' + frame);
        
        // /topic/chat/{matchId} 경로를 구독하여 매칭에 대한 채팅 메시지 수신
        stompClient.subscribe('/topic/chat/' + matchId, function (messageOutput) {
            const message = JSON.parse(messageOutput.body);
            console.log("Received message: ", message);
            
            // 메시지를 웹 페이지에 표시 (예: 콘솔 출력 또는 HTML 업데이트)
            displayMessage(message);
        });
    }, function(error) {
        console.log("Error: " + error);
    });

    // 채팅 메시지 전송 함수
    function sendMessage(messageContent) {
        const message = {
            message: messageContent,
            matchId: matchId
        };

        stompClient.send("/app/sendMessage/" + matchId, {}, JSON.stringify(message));  // 서버에 메시지 전송
    }

    // 메시지 화면에 출력하는 함수
    function displayMessage(message) {
        const messageBox = document.getElementById('messages');  // 수정: 'messageBox' -> 'messages'
        const newMessage = document.createElement('div');
        newMessage.textContent = message.message;
        messageBox.appendChild(newMessage);

        // 메시지 박스가 항상 최신 메시지로 스크롤되게 설정
        messageBox.scrollTop = messageBox.scrollHeight;
    }

    // 버튼 클릭 시 메시지 전송
    document.getElementById('sendButton').addEventListener('click', function() {
        const messageInput = document.getElementById('messageInput');
        const messageContent = messageInput.value.trim();

        if (messageContent) {
            sendMessage(messageContent);
            messageInput.value = '';  // 메시지 전송 후 입력란 비우기
        }
    });

</script>

</body>
</html>
